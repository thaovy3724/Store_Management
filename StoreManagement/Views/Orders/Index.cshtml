@using StoreManagement.Models.Entities
@model StoreManagement.Models.Pages.Orders.OrdersPageViewModel

@{
    ViewData["Title"] = "Quản lý đơn hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="fw-bold">Lịch sử đơn hàng</h3>
</div>
<!-- Thanh lọc -->
<div class="d-flex justify-content-between align-items-start mb-3 flex-wrap gap-2">
    <!-- Thanh lọc bên trái -->
    <div class="d-flex flex-wrap gap-2 align-items-center flex-grow-1">

        <!-- Lọc theo trạng thái -->
        @{
            var statusDict = new Dictionary<OrderStatus, string> {
                { OrderStatus.Pending, "Chờ xử lý" },
                { OrderStatus.Paid, "Đã thanh toán" },
                { OrderStatus.Cancelled, "Đã hủy" }
                };
        }

        <select class="form-select form-select-sm filter-status" name="status" style="width: 180px;">
            <option value="-1">Tất cả trạng thái</option>
            @foreach (var kvp in statusDict)
            {
                var key = (int)kvp.Key;
                if (Model.Status.HasValue && key == Model.Status.Value)
                {
                    <option value="@key" selected>@kvp.Value</option>
                }
                else
                {
                    <option value="@key">@kvp.Value</option>
                }
            }
        </select>

        <!-- Lọc theo khoảng giá -->
        <div class="input-group input-group-sm filter-price-group" style="width: 260px;">
            <span class="input-group-text">Giá từ</span>
            <input type="number" class="form-control filter-price-min" value="@(Model.PriceFrom)" name="priceMin" placeholder="0" min="0">
            <span class="input-group-text">đến</span>
            <input type="number" class="form-control filter-price-max" value="@(Model.PriceTo)" name="priceMax" placeholder="0" min="0">
        </div>

        <!-- Ô tìm kiếm -->
        <div class="input-group input-group-sm filter-search-group" style="width: 300px;">
            <input type="text" class="form-control" id="filter-order-id" value="@Model.Search" name="orderId" placeholder="Nhập mã đơn hàng">
            <button class="btn btn-primary btn-search-order" id="btnSearch" type="button">
                <i class="bi bi-search"></i>
            </button>
        </div>
    </div>
</div>
<div class="card shadow-sm">
    <div class="card-body">
        <div class="table-responsive">

            <table class="table table-bordered align-middle">
                <thead class="table-light thead-separator ">
                    <tr class="text-center">
                        <th style="width:100px;">ID</th>
                        <th>Tên khách hàng</th>
                        <th>Ngày tạo đơn</th>
                        <th>Tổng giá trị đơn hàng</th>
                        <th>Trạng thái đơn hàng</th>
                        <th style="width:150px;">Hành động</th>
                    </tr>
                </thead>
                <tbody id="orderList">
                    @if (Model.Orders == null || !Model.Orders.Any())
                    {
                        <tr>
                            <td colspan="5" class="text-center">Chưa có đơn hàng</td>
                        </tr>
                    } else
                    {
                        @foreach (var order in Model.Orders)
                        {
                            <tr class="text-center">
                                <td class="text-center">@order.OrderId</td>
                                <td>@order.CustomerName</td>
                                <td>@order.OrderDate.ToString("dd/MM/yyyy hh:mm:ss tt")</td>
                                <td>@String.Format("{0:N0} đ", order.TotalAmount)</td>
                                <td>
                                    @if(@order.Status == OrderStatus.Pending){
                                        <span class="badge rounded-pill px-3 py-2 fw-semibold" style="background-color:#ffc1071a; color:#b8860b; border:1px solid #ffc107;">
                                            Chờ xử lý
                                        </span>
                                    } else if(@order.Status == OrderStatus.Paid){
                                        <span class="badge rounded-pill px-3 py-2 fw-semibold" style="background-color:#0d6efd1a; color:#0d6efd; border:1px solid #0d6efd;">
                                            Đã thanh toán
                                        </span>
                                    } else if(@order.Status == OrderStatus.Cancelled){
                                        <span class="badge rounded-pill px-3 py-2 fw-semibold"
                                              style="background-color: #dc35451a; color: #dc3545; border: 1px solid #dc3545;">
                                            Đã hủy
                                        </span>
                                    }
                                </td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-light border me-1 btn-view" title="Xem" data-bs-toggle="modal" data-bs-target="#orderHistoryModal" data-order-id="@order.OrderId">
                                        <i class="bi bi-eye text-primary"></i>
                                    </button>
                                    <button class="btn btn-sm btn-light border me-1 btn-print" data-order-id="@order.OrderId" title="In hóa đơn">
                                        <i class="bi bi-printer text-secondary"></i>
                                    </button>
                                </td>
                            </tr>
                        } 
                    }
                </tbody>
            </table>
        </div>
        <!-- Phân trang-->
        @await Html.PartialAsync("Pagination", (object)Model)
    </div>
</div>
    <!-- Modal dùng chung -->
@section Modals {
    <div class="modal fade" id="orderHistoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">

                <!-- Header -->
                <div class="modal-header">
                    <h5 class="modal-title" id="orderHistoryModalTitle">Quản lý đơn hàng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <!-- Body -->
                <div class="modal-body">
                    <form id="orderHistoryForm" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-7">
                                <table class="table table-bordered cart-table thead-separator">
                                    <thead class="table-light">
                                        <tr class="text-center">
                                            <th>Sản phẩm</th>
                                            <th>Hình ảnh</th>
                                            <th>Đơn giá</th>
                                            <th>Số lượng</th>
                                            <th>Thành tiền</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cart-body" class="align-middle">
                                        <!-- JS sẽ clone template này -->
                                        <tr class="order-item-template d-none">
                                            <td class="order-history-product-name text-center"></td>
                                            <td class="order-history-product-img text-center">
                                                <img src="" alt="" style="width:60px; height:60px; object-fit:cover; border-radius:4px;">
                                            </td>
                                            <td class="order-history-product-price text-center"></td>
                                            <td class="order-history-product-quantity text-center"></td>
                                            <td class="order-history-product-subtotal text-center"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="col-md-5">
                                <div class="card shadow-sm">
                                    <div class="card-header card-header-order bg-light fw-semibold">
                                        Thông tin hóa đơn #
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2 d-flex justify-content-between">
                                            <span class="fw-semibold">Tên khách hàng:</span>
                                            <span class="order-history-customername"></span>
                                        </div>
                                        <div class="mb-2 d-flex justify-content-between">
                                            <span class="fw-semibold">Nhân viên phụ trách:</span>
                                            <span class="order-history-username"></span>
                                        </div>
                                        <div class="mb-2 d-flex justify-content-between">
                                            <span class="fw-semibold">Ngày tạo đơn hàng:</span>
                                            <span class="order-history-orderdate"></span>
                                        </div>
                                        <div class="mb-2 d-flex justify-content-between">
                                            <span class="fw-semibold">Trạng thái:</span>
                                            <span class="badge rounded-pill px-3 py-2 fw-semibold order-history-orderstatus"
                                                  style="background-color:#ffc1071a; color:#b8860b; border:1px solid #ffc107;">
                                            </span>
                                        </div>
                                        <div class="mb-2 d-flex justify-content-between order-history-paymentmethod-div">
                                            <span class="fw-semibold">Phương thức thanh toán:</span>
                                            <div>
                                                <button class="btn btn-sm btn-outline-primary btn-order-history-paymentmethod" type="button"
                                                        data-bs-toggle="collapse"
                                                        data-bs-target="#paymentInfo"
                                                        aria-expanded="false"
                                                        aria-controls="paymentInfo"
                                                        title="Xem chi tiết thanh toán">
                                                    
                                                </button>
                                            </div>
                                        </div>

                                        <div class="collapse mt-2 order-history-paymentmethod-div-collapse" id="paymentInfo">
                                            <div class="card card-body">
                                                <p>Phương thức: <span class="order-history-paymentmethod"></span></p>
                                                <p>Số tiền: <span class="order-history-paymentamount"></span></p>
                                                <p>Ngày thanh toán: <span class="order-history-paymentdate"></span></p>
                                            </div>
                                        </div>
                                        <hr>
                                        <div class="mb-2 d-flex justify-content-between">
                                            <span class="fw-semibold">Thành tiền:</span>
                                            <span class="order-history-totalamount"></span>
                                        </div>
                                        <div class="mb-2 d-flex justify-content-between">
                                            <span class="fw-semibold">Mã giảm giá:</span>
                                            <span class="order-history-promotioncode"></span>
                                        </div>
                                        <div class="mb-2 d-flex justify-content-between">
                                            <span class="fw-semibold">Số tiền giảm:</span>
                                            <span class="order-history-discountamount"></span>
                                        </div>
                                        <hr>
                                        <div class="mb-2 d-flex justify-content-between fs-5">
                                            <span class="fw-bold">Tổng thanh toán:</span>
                                            <span class="order-history-finalamount fw-bold text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="card-footer text-end">
                                        <button type="button" class="btn btn-outline-primary btn-sm me btn-print">
                                            <i class="bi bi-printer"></i> In hóa đơn
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Footer -->
                <div class="modal-footer">
                    <button type="submit" form="orderHistoryForm" id="orderHistoryModalSaveBtn" class="btn btn-primary">Lưu</button>
                </div>
            </div>
        </div>
    </div>
}



@section Scripts {
    <script src="../js/Toast.js"></script>
    <script src="../js/OrderManager.js"></script>
}
