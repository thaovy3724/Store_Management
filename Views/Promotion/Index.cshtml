@using StoreManagement.Models.Entities
@model StoreManagement.Models.ViewModels.PromotionPageViewModel

@{
    ViewData["Title"] = "Quản lý mã giảm giá";
}

<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="fw-bold">Quản lý khuyến mãi</h3>
    </div>

    <!-- Thanh lọc -->
    <div class="d-flex justify-content-between align-items-start mb-3 flex-wrap gap-2">
        <!-- Thanh lọc bên trái -->
        <div class="d-flex flex-wrap gap-2 align-items-center flex-grow-1">
            <!-- Lọc trạng thái -->
            <select id="filterStatus" class="form-select form-select-sm" style="width: 180px;">
            <option value="-1">Tất cả trạng thái</option>
            @foreach (var s in Model.StatusList)
                {
                    string text = s switch
                    {
                        PromotionStatus.Active => "Hoạt động",
                        PromotionStatus.Inactive => "Đã khóa",
                        _ => s.ToString()
                    };
                    if (Model.FilterStatus == s.ToString())
                    {
                        <option value="@s" selected>@text</option>
                    }
                    else
                    {
                        <option value="@s">@text</option>
                    }
                }
            </select>

            <!-- Lọc từ ngày -->
            <div class="input-group input-group-sm" style="width: 200px;">
                <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                <input type="date" id="filterFromDate" class="form-control" value="@(Model.FromDate?.ToString("yyyy-MM-dd"))">
            </div>

            <!-- Lọc đến ngày -->
            <div class="input-group input-group-sm" style="width: 200px;">
                <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                <input type="date" id="filterToDate" class="form-control" value="@(Model.ToDate?.ToString("yyyy-MM-dd"))">
            </div>

            <!-- Ô tìm kiếm -->
            <div class="input-group input-group-sm" style="width: 300px;">
                <input type="text" id="searchInput" class="form-control" placeholder="Nhập mã khuyến mãi" value="@Model.SearchTerm">
                <button id="btnSearch" class="btn btn-primary btn-search" type="button">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </div>

        <!-- Nút Thêm mới bên phải -->
        <button class="btn btn-primary btn-sm btn-add" data-bs-toggle="modal" data-bs-target="#promotionModal" data-action="view_add">
            <i class="bi bi-plus-circle"></i> Thêm mới
        </button>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered align-middle">
                    <thead class="table-light thead-separator">
                        <tr class="text-center align-middle">
                            <th style="width:120px;">Mã</th>
                            <th>Giá trị đơn hàng tối thiểu</th>
                            <th>Loại</th>
                            <th>Giới hạn lần sử dụng</th>
                            <th>Ngày bắt đầu</th>
                            <th>Ngày kết thúc</th>
                            <th>Trạng thái</th>
                            <th style="width:150px;">Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                    @if (Model.Promotions != null && Model.Promotions.Any())
                    {
                        foreach (var item in Model.Promotions)
                        {
                            <tr>
                                <td>@item.PromoCode</td>
                                <td>@item.MinOrderAmount.ToString("N0") đ</td>
                                <td>@item.DiscountType.ToString()</td>
                                <td>@item.UsageLimit</td>
                                <td>@item.StartDate.ToString("dd/MM/yyyy")</td>
                                <td>@item.EndDate.ToString("dd/MM/yyyy")</td>
                                <td class="text-center">
                                    @if (item.Status == PromotionStatus.Active)
                                    {
                                        <span class="badge rounded-pill px-3 py-2 fw-semibold"
                                              style="background-color:#0d6efd1a; color:#0d6efd; border:1px solid #0d6efd;">
                                            @item.StatusText
                                        </span>
                                    }
                                    else if (item.Status == PromotionStatus.Inactive)
                                    {
                                        <span class="badge rounded-pill px-3 py-2 fw-semibold"
                                              style="background-color:#ffc1071a; color:#b8860b; border:1px solid #ffc107;">
                                            @item.StatusText
                                        </span>
                                    }
                                </td>
                                <td class="text-center">
                                        <button data-id="@item.PromoId" class="btn btn-sm btn-light border me-1 btn-view" title="Xem" data-bs-toggle="modal" data-bs-target="#promotionModal" data-action="view">
                                        <i class="bi bi-eye text-primary"></i>
                                    </button>
                                        <button data-id="@item.PromoId" class="btn btn-sm btn-light border me-1 btn-edit" title="Sửa" data-bs-toggle="modal" data-bs-target="#promotionModal" data-action="view_edit">
                                        <i class="bi bi-pencil text-success"></i>
                                    </button>
                                        @if (item.Status == PromotionStatus.Active)
                                        {
                                            <button data-id="@item.PromoId" class="btn btn-sm btn-light border me-1 btn-lock" title="Khóa/ Mở khóa" data-action="delete">
                                                <i class="bi bi-unlock text-primary"></i>
                                            </button>
                                        }
                                        else if (item.Status == PromotionStatus.Inactive)
                                        {
                                            <button data-id="@item.PromoId" class="btn btn-sm btn-light border me-1 btn-lock" title="Khóa/ Mở khóa" data-action="delete">
                                                <i class="bi bi-lock text-primary"></i>
                                            </button>
                                        }
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="8" class="text-center text-muted">Không có dữ liệu</td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>

            <!-- Phân trang -->
            <div id="paginationContainer">
                @await Html.PartialAsync("Pagination", (object)Model)
            </div>
        </div>
    </div>
</div>

<!-- Modal dùng chung -->
<div class="modal fade" id="promotionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content">
            <!-- Header -->
            <div class="modal-header">
                <h5 class="modal-title" id="promotionModalTitle">Quản lý khuyến mãi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Body -->
            <div class="modal-body">
                <form id="promotionForm">
                    <div class="mb-3">
                        <label class="form-label">Mã khuyến mãi*</label>
                        <input type="text" class="form-control" id="code" name="PromoCode" maxlength="20">
                        <small id="promotion-PromoCode-error" class="form-text text-danger d-none"></small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Loại khuyến mãi*</label>
                        <select class="form-select" id="discountType" name="DiscountType">
                            <option value="" selected>-- Chọn loại --</option>
                            <option value="0">Percent</option>
                            <option value="1">Fixed</option>
                        </select>
                        <small id="promotion-DiscountType-error" class="form-text text-danger d-none"></small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Mô tả khuyến mãi</label>
                        <textarea class="form-control" id="description" name="Description" rows="3" placeholder="Nhập mô tả cho khuyến mãi (tùy chọn)"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Giá trị khuyến mãi*</label>
                        <input type="number" class="form-control" id="discountValue" name="DiscountValue" min="0">
                        <small id="promotion-DiscountValue-error" class="form-text text-danger d-none"></small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Giá trị đơn hàng tối thiểu*</label>
                        <input type="number" class="form-control" id="minOrderAmount" name="MinOrderAmount" min="0">
                        <small id="promotion-MinOrderAmount-error" class="form-text text-danger d-none"></small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Giới hạn lần sử dụng*</label>
                        <input type="number" class="form-control" id="usageLimit" name="UsageLimit" min="0">
                        <small id="promotion-UsageLimit-error" class="form-text text-danger d-none"></small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Ngày bắt đầu*</label>
                        <input type="date" class="form-control" id="startDate" name="StartDate">
                        <small id="promotion-StartDate-error" class="form-text text-danger d-none"></small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Ngày kết thúc*</label>
                        <input type="date" class="form-control" id="endDate" name="EndDate">
                        <small id="promotion-EndDate-error" class="form-text text-danger d-none"></small>
                    </div>
                </form>
            </div>


            <!-- Footer -->
            <div class="modal-footer">
                <button type="button" form="promotionForm" id="promotionModalSaveBtn" class="btn btn-primary" data-action="add">Lưu</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/Toast.js"></script>
    <script src="~/js/Promotion.js"></script>
}
